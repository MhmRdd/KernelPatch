/* SPDX-License-Identifier: GPL-2.0-or-later */
/* Copyright (C) 2025 mhmrdd. All Rights Reserved. */

/*
 * ARM64 Disassembler Library
 *
 * Lightweight ARM64 instruction disassembly with full operand decoding.
 * Adapted for use in host tools (kptools).
 */

#ifndef ARM64_DISASM_H
#define ARM64_DISASM_H

#include "compat.h"

#ifdef __cplusplus
extern "C" {
#endif

/* Register types */
typedef enum {
    ARM64_REG_NONE = 0,
    ARM64_REG_X0, ARM64_REG_X1, ARM64_REG_X2, ARM64_REG_X3,
    ARM64_REG_X4, ARM64_REG_X5, ARM64_REG_X6, ARM64_REG_X7,
    ARM64_REG_X8, ARM64_REG_X9, ARM64_REG_X10, ARM64_REG_X11,
    ARM64_REG_X12, ARM64_REG_X13, ARM64_REG_X14, ARM64_REG_X15,
    ARM64_REG_X16, ARM64_REG_X17, ARM64_REG_X18, ARM64_REG_X19,
    ARM64_REG_X20, ARM64_REG_X21, ARM64_REG_X22, ARM64_REG_X23,
    ARM64_REG_X24, ARM64_REG_X25, ARM64_REG_X26, ARM64_REG_X27,
    ARM64_REG_X28, ARM64_REG_X29, ARM64_REG_X30, ARM64_REG_XZR, ARM64_REG_SP,

    ARM64_REG_W0, ARM64_REG_W1, ARM64_REG_W2, ARM64_REG_W3,
    ARM64_REG_W4, ARM64_REG_W5, ARM64_REG_W6, ARM64_REG_W7,
    ARM64_REG_W8, ARM64_REG_W9, ARM64_REG_W10, ARM64_REG_W11,
    ARM64_REG_W12, ARM64_REG_W13, ARM64_REG_W14, ARM64_REG_W15,
    ARM64_REG_W16, ARM64_REG_W17, ARM64_REG_W18, ARM64_REG_W19,
    ARM64_REG_W20, ARM64_REG_W21, ARM64_REG_W22, ARM64_REG_W23,
    ARM64_REG_W24, ARM64_REG_W25, ARM64_REG_W26, ARM64_REG_W27,
    ARM64_REG_W28, ARM64_REG_W29, ARM64_REG_W30, ARM64_REG_WZR, ARM64_REG_WSP,

    ARM64_REG_V0, ARM64_REG_V1, ARM64_REG_V2, ARM64_REG_V3,
    ARM64_REG_V4, ARM64_REG_V5, ARM64_REG_V6, ARM64_REG_V7,
    ARM64_REG_V8, ARM64_REG_V9, ARM64_REG_V10, ARM64_REG_V11,
    ARM64_REG_V12, ARM64_REG_V13, ARM64_REG_V14, ARM64_REG_V15,
    ARM64_REG_V16, ARM64_REG_V17, ARM64_REG_V18, ARM64_REG_V19,
    ARM64_REG_V20, ARM64_REG_V21, ARM64_REG_V22, ARM64_REG_V23,
    ARM64_REG_V24, ARM64_REG_V25, ARM64_REG_V26, ARM64_REG_V27,
    ARM64_REG_V28, ARM64_REG_V29, ARM64_REG_V30, ARM64_REG_V31,

    ARM64_REG_D0, ARM64_REG_D1, ARM64_REG_D2, ARM64_REG_D3,
    ARM64_REG_D4, ARM64_REG_D5, ARM64_REG_D6, ARM64_REG_D7,
    ARM64_REG_D8, ARM64_REG_D9, ARM64_REG_D10, ARM64_REG_D11,
    ARM64_REG_D12, ARM64_REG_D13, ARM64_REG_D14, ARM64_REG_D15,
    ARM64_REG_D16, ARM64_REG_D17, ARM64_REG_D18, ARM64_REG_D19,
    ARM64_REG_D20, ARM64_REG_D21, ARM64_REG_D22, ARM64_REG_D23,
    ARM64_REG_D24, ARM64_REG_D25, ARM64_REG_D26, ARM64_REG_D27,
    ARM64_REG_D28, ARM64_REG_D29, ARM64_REG_D30, ARM64_REG_D31,

    ARM64_REG_S0, ARM64_REG_S1, ARM64_REG_S2, ARM64_REG_S3,
    ARM64_REG_S4, ARM64_REG_S5, ARM64_REG_S6, ARM64_REG_S7,
    ARM64_REG_S8, ARM64_REG_S9, ARM64_REG_S10, ARM64_REG_S11,
    ARM64_REG_S12, ARM64_REG_S13, ARM64_REG_S14, ARM64_REG_S15,
    ARM64_REG_S16, ARM64_REG_S17, ARM64_REG_S18, ARM64_REG_S19,
    ARM64_REG_S20, ARM64_REG_S21, ARM64_REG_S22, ARM64_REG_S23,
    ARM64_REG_S24, ARM64_REG_S25, ARM64_REG_S26, ARM64_REG_S27,
    ARM64_REG_S28, ARM64_REG_S29, ARM64_REG_S30, ARM64_REG_S31,
} arm64_reg_t;

/* Condition codes */
typedef enum {
    ARM64_CC_EQ = 0, ARM64_CC_NE, ARM64_CC_CS, ARM64_CC_CC,
    ARM64_CC_MI, ARM64_CC_PL, ARM64_CC_VS, ARM64_CC_VC,
    ARM64_CC_HI, ARM64_CC_LS, ARM64_CC_GE, ARM64_CC_LT,
    ARM64_CC_GT, ARM64_CC_LE, ARM64_CC_AL, ARM64_CC_NV
} arm64_cc_t;

/* System registers */
typedef enum {
    ARM64_SYSREG_UNKNOWN = 0,
    ARM64_SYSREG_NZCV,
    ARM64_SYSREG_FPCR,
    ARM64_SYSREG_FPSR,
    ARM64_SYSREG_TPIDR_EL0,
    ARM64_SYSREG_TPIDRRO_EL0,
    ARM64_SYSREG_TPIDR_EL1,
    ARM64_SYSREG_SP_EL0,
    ARM64_SYSREG_SPSR_EL1,
    ARM64_SYSREG_ELR_EL1,
    ARM64_SYSREG_SCTLR_EL1,
    ARM64_SYSREG_ACTLR_EL1,
    ARM64_SYSREG_CPACR_EL1,
    ARM64_SYSREG_TTBR0_EL1,
    ARM64_SYSREG_TTBR1_EL1,
    ARM64_SYSREG_TCR_EL1,
    ARM64_SYSREG_ESR_EL1,
    ARM64_SYSREG_FAR_EL1,
    ARM64_SYSREG_MAIR_EL1,
    ARM64_SYSREG_VBAR_EL1,
    ARM64_SYSREG_CONTEXTIDR_EL1,
    ARM64_SYSREG_CNTKCTL_EL1,
    ARM64_SYSREG_CNTFRQ_EL0,
    ARM64_SYSREG_CNTPCT_EL0,
    ARM64_SYSREG_CNTVCT_EL0,
    ARM64_SYSREG_CNTP_CTL_EL0,
    ARM64_SYSREG_CNTP_CVAL_EL0,
    ARM64_SYSREG_CNTV_CTL_EL0,
    ARM64_SYSREG_CNTV_CVAL_EL0,
    ARM64_SYSREG_DAIF,
    ARM64_SYSREG_ICC_PMR_EL1,
    ARM64_SYSREG_TPIDR_EL2
} arm64_sysreg_t;

/* Instruction types */
typedef enum {
    ARM64_INS_INVALID = 0,
    ARM64_INS_ADD_REG, ARM64_INS_ADD_IMM, ARM64_INS_SUB_REG, ARM64_INS_SUB_IMM,
    ARM64_INS_ADDS_REG, ARM64_INS_ADDS_IMM, ARM64_INS_SUBS_REG, ARM64_INS_SUBS_IMM,
    ARM64_INS_MUL, ARM64_INS_MADD, ARM64_INS_MSUB, ARM64_INS_MNEG,
    ARM64_INS_UDIV, ARM64_INS_SDIV,
    ARM64_INS_ADC, ARM64_INS_SBC, ARM64_INS_ADCS, ARM64_INS_SBCS,
    ARM64_INS_AND_REG, ARM64_INS_AND_IMM, ARM64_INS_ANDS_REG, ARM64_INS_ANDS_IMM,
    ARM64_INS_ORR_REG, ARM64_INS_ORR_IMM,
    ARM64_INS_EOR_REG, ARM64_INS_EOR_IMM, ARM64_INS_BIC_REG,
    ARM64_INS_LSL_REG, ARM64_INS_LSR_REG, ARM64_INS_ASR_REG, ARM64_INS_ROR_REG,
    ARM64_INS_ROR_IMM,
    ARM64_INS_CMP_REG, ARM64_INS_CMP_IMM, ARM64_INS_TST_REG, ARM64_INS_TST_IMM,
    ARM64_INS_CMN_IMM, ARM64_INS_CMN_REG,
    ARM64_INS_MOV_REG, ARM64_INS_MOVZ, ARM64_INS_MOVN, ARM64_INS_MOVK,
    ARM64_INS_SBFM, ARM64_INS_BFM, ARM64_INS_UBFM, ARM64_INS_SXTW,
    ARM64_INS_LSL_IMM, ARM64_INS_LSR_IMM,
    ARM64_INS_B, ARM64_INS_BL, ARM64_INS_BR, ARM64_INS_BLR,
    ARM64_INS_B_COND, ARM64_INS_CBZ, ARM64_INS_CBNZ, ARM64_INS_TBZ, ARM64_INS_TBNZ,
    ARM64_INS_LDR_IMM, ARM64_INS_LDR_POST, ARM64_INS_LDR_PRE, ARM64_INS_LDR_REG,
    ARM64_INS_STR_IMM, ARM64_INS_STR_POST, ARM64_INS_STR_PRE, ARM64_INS_STR_REG,
    ARM64_INS_LDRB, ARM64_INS_STRB, ARM64_INS_LDRH, ARM64_INS_STRH,
    ARM64_INS_LDRSB, ARM64_INS_LDRSH, ARM64_INS_LDRSW,
    ARM64_INS_LDP, ARM64_INS_STP, ARM64_INS_LDUR, ARM64_INS_STUR, ARM64_INS_PRFM,
    ARM64_INS_LDXR, ARM64_INS_STXR, ARM64_INS_LDAXR, ARM64_INS_STLXR,
    ARM64_INS_LDAR, ARM64_INS_LDAPR, ARM64_INS_STLR, ARM64_INS_STLRB,
    ARM64_INS_LDADD, ARM64_INS_LDCLR, ARM64_INS_LDEOR, ARM64_INS_LDSET,
    ARM64_INS_LDSETA,
    ARM64_INS_STADD, ARM64_INS_CASA, ARM64_INS_SWPA, ARM64_INS_CAS, ARM64_INS_CASP,
    ARM64_INS_NOP, ARM64_INS_RET, ARM64_INS_MSR, ARM64_INS_MRS,
    ARM64_INS_SVC, ARM64_INS_HVC, ARM64_INS_SMC, ARM64_INS_BRK,
    ARM64_INS_ISB, ARM64_INS_DSB, ARM64_INS_DMB, ARM64_INS_CSDB, ARM64_INS_BTI,
    ARM64_INS_SEVL, ARM64_INS_WFE, ARM64_INS_YIELD,
    ARM64_INS_PACIASP, ARM64_INS_AUTIASP, ARM64_INS_PACIAZ, ARM64_INS_AUTIAZ,
    ARM64_INS_PACIA, ARM64_INS_AUTIA, ARM64_INS_PACIB, ARM64_INS_AUTIB,
    ARM64_INS_PACDA, ARM64_INS_AUTDA, ARM64_INS_PACDB, ARM64_INS_AUTDB,
    ARM64_INS_XPACI, ARM64_INS_XPACD,
    ARM64_INS_FADD, ARM64_INS_FSUB, ARM64_INS_FMUL, ARM64_INS_FDIV,
    ARM64_INS_FMOV, ARM64_INS_FCMP, ARM64_INS_FCVT,
    ARM64_INS_ADD_VEC, ARM64_INS_SUB_VEC, ARM64_INS_MUL_VEC,
    ARM64_INS_AND_VEC, ARM64_INS_ORR_VEC, ARM64_INS_EOR_VEC,
    ARM64_INS_MOVI, ARM64_INS_FMLA, ARM64_INS_FMLS,
    ARM64_INS_ADRP, ARM64_INS_ADR,
    ARM64_INS_CSEL, ARM64_INS_CSINC, ARM64_INS_CSINV, ARM64_INS_CSNEG,
    ARM64_INS_NGC,
    ARM64_INS_LD1, ARM64_INS_ST1, ARM64_INS_LD2, ARM64_INS_ST2,
} arm64_ins_t;

/* Operand types */
typedef enum {
    ARM64_OP_INVALID = 0,
    ARM64_OP_REG,
    ARM64_OP_REG_EXT,
    ARM64_OP_IMM,
    ARM64_OP_IMM_SHIFT,
    ARM64_OP_MEM,
    ARM64_OP_COND,
    ARM64_OP_SYSREG
} arm64_op_type_t;

/* Memory operand */
typedef struct {
    arm64_reg_t base, index;
    int64_t disp;
    bool pre_indexed, post_indexed;
    int extend_type, shift;
} arm64_mem_t;

/* Extended register operand */
typedef struct {
    arm64_reg_t reg;
    int extend_type;
    int shift;
} arm64_reg_operand_t;

/* Shifted immediate operand */
typedef struct {
    int64_t imm;
    int shift;
} arm64_imm_operand_t;

/* Generic operand */
typedef struct {
    arm64_op_type_t type;
    union {
        arm64_reg_t reg;
        arm64_reg_operand_t reg_ext;
        int64_t imm;
        arm64_imm_operand_t imm_shift;
        arm64_mem_t mem;
        arm64_cc_t cc;
        arm64_sysreg_t sysreg;
    };
} arm64_operand_t;

/* Decoded instruction */
typedef struct {
    arm64_ins_t id;
    uint64_t address;
    uint32_t opcode;
    uint8_t op_count;
    arm64_operand_t operands[6];
} arm64_insn_t;

/* Disassembler context */
typedef struct {
    const uint8_t *code;
    size_t size, pos;
    uint64_t address;
    bool big_endian;
} arm64_ctx_t;

/* Memory allocation callbacks */
typedef void *(*arm64_alloc_fn)(size_t size);
typedef void (*arm64_free_fn)(void *addr);

extern arm64_alloc_fn g_arm64_alloc;
extern arm64_free_fn g_arm64_free;

/* API */
void arm64_ctx_init(arm64_alloc_fn alloc_fn, arm64_free_fn free_fn);
arm64_ctx_t *arm64_ctx_create(const uint8_t *code, size_t size,
                               uint64_t address, bool big_endian);
void arm64_ctx_destroy(arm64_ctx_t *ctx);
bool arm64_disasm_one(arm64_ctx_t *ctx, arm64_insn_t *insn);
arm64_insn_t arm64_disasm_addr(const uint8_t *addr, bool big_endian);
void arm64_log_insn(const arm64_insn_t *insn);
const char *arm64_reg_name(arm64_reg_t reg);
const char *arm64_cc_name(arm64_cc_t cc);
const char *arm64_sysreg_name(arm64_sysreg_t sysreg);
const char *arm64_ins_name(arm64_ins_t id);

#ifdef __cplusplus
}
#endif

#endif /* ARM64_DISASM_H */